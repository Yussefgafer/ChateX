<<<<<<< SEARCH
    fun processIncomingJson(fromEndpointId: String, json: String) {
        // Security: Limit payload size to prevent OOM/Overflow attacks
        if (json.length > 102400) return
=======
    fun processIncomingJson(fromEndpointId: String, json: String) {
        pruneGateways()
        // Security: Limit payload size to prevent OOM/Overflow attacks
        if (json.length > 102400) return
>>>>>>> REPLACE
<<<<<<< SEARCH
    private fun shouldAck(type: PacketType): Boolean = when(type) {
        PacketType.CHAT, PacketType.IMAGE, PacketType.VOICE, PacketType.FILE -> true
        else -> false
    }
}
=======
    private fun pruneGateways() {
        val now = System.currentTimeMillis()
        val iterator = gatewayNodes.entries.iterator()
        while (iterator.hasNext()) {
            val entry = iterator.next()
            if (now - entry.value > 300000) { // 5 minutes
                iterator.remove()
                Log.d("MeshEngine", "Pruned stale gateway: ${entry.key}")
            }
        }
    }

    private fun shouldAck(type: PacketType): Boolean = when(type) {
        PacketType.CHAT, PacketType.IMAGE, PacketType.VOICE, PacketType.FILE -> true
        else -> false
    }
}
>>>>>>> REPLACE
